<ion-header translucent="true" class="header">
  <ion-toolbar>
    <ion-title>SPORE_CORE</ion-title>
    <div class="header__status" slot="end">
      <span class="status">DIFF {{ difficulty }}</span>
      <span class="status" [class.status--bad]="!chainIsHealthy()">
        {{ chainIsHealthy() ? 'CHAIN OK' : 'CHAIN BAD' }}
      </span>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" [scrollY]="true" class="page">
  <div class="container">
    <div class="layout">
      <section class="panel actions">
        <div class="panel__header">
          <h2>Actions</h2>
          <p>Queue transactions and mine blocks locally.</p>
        </div>

        <div class="section">
          <h3>Queue transaction</h3>
          <form class="stack" [formGroup]="transactionForm" (ngSubmit)="onCreateTransaction()">
            <ion-item fill="outline" class="field">
              <ion-label position="stacked">Sender</ion-label>
              <ion-input formControlName="sender" autocomplete="off" inputmode="text"
                placeholder="forest-treasury"></ion-input>
            </ion-item>
            <ion-item fill="outline" class="field">
              <ion-label position="stacked">Receiver</ion-label>
              <ion-input formControlName="receiver" autocomplete="off" inputmode="text"
                placeholder="grove-reserve"></ion-input>
            </ion-item>
            <ion-item fill="outline" class="field">
              <ion-label position="stacked">Amount (MSH)</ion-label>
              <ion-input type="number" formControlName="amount" min="0.01" step="0.01"
                inputmode="decimal"></ion-input>
            </ion-item>
            <ion-item fill="outline" class="field">
              <ion-label position="stacked">Memo (optional)</ion-label>
              <ion-input formControlName="note" autocomplete="off" inputmode="text"
                placeholder="What is this transfer for?"></ion-input>
            </ion-item>
            <div class="actions__row">
              <ion-button type="submit" [disabled]="transactionForm.invalid">Queue</ion-button>
              <span class="hint">Pending {{ pending().length }}</span>
            </div>
          </form>
        </div>

        <div class="section">
          <h3>Mine block</h3>
          <div class="meta">
            <span>Difficulty {{ difficulty }}</span>
            <span>Reward {{ minerReward }} MSH</span>
          </div>
          <form class="stack" [formGroup]="mineForm" (ngSubmit)="onMineBlock()">
            <ion-item fill="outline" class="field">
              <ion-label position="stacked">Miner address</ion-label>
              <ion-input formControlName="miner" autocomplete="off" inputmode="text"
                placeholder="mycelium-operator"></ion-input>
            </ion-item>
            <div class="actions__row">
              <ion-button type="submit" [disabled]="mineForm.invalid || mining()">
                {{ mining() ? 'Mining...' : 'Mine block' }}
              </ion-button>
              <ion-spinner *ngIf="mining()" name="crescent"></ion-spinner>
            </div>
          </form>
        </div>

        <div class="section">
          <div class="section__header">
            <h3>Pending queue</h3>
            <span class="badge">{{ pending().length }}</span>
          </div>
          <div class="pending">
            <div *ngIf="pending().length === 0" class="empty">
              No pending transactions.
            </div>
            <div class="pending__list" *ngIf="pending().length > 0">
              <div class="pending__item" *ngFor="let tx of pending(); trackBy: trackTransaction">
                <div class="pending__line">
                  <span class="mono">{{ tx.sender }}</span>
                  <span class="arrow">-></span>
                  <span class="mono">{{ tx.receiver }}</span>
                </div>
                <div class="pending__line">{{ tx.amount | number : '1.0-2' }} MSH</div>
                <div class="pending__line dim" *ngIf="tx.note">"{{ tx.note }}"</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel chain">
        <div class="panel__header">
          <h2>Chain</h2>
          <div class="stats">
            <span>Height {{ stats().height }}</span>
            <span>Minted {{ stats().minted | number : '1.0-2' }} MSH</span>
            <span>Transactions {{ stats().txCount }}</span>
          </div>
        </div>
        <div *ngIf="displayChain().length === 0" class="empty">
          No blocks yet. Mine the next one.
        </div>
        <div class="chain__list" *ngIf="displayChain().length > 0">
          <div class="block" *ngFor="let block of displayChain(); trackBy: trackBlock">
            <div class="block__header">
              <span>Block #{{ block.index }}</span>
              <span>{{ block.transactions.length }} tx</span>
              <span>{{ block.timestamp | date : 'short' }}</span>
            </div>
            <div class="block__line">
              Hash <span class="mono">{{ block.hash }}</span>
            </div>
            <div class="block__line">
              Prev <span class="mono">{{ block.previousHash }}</span>
            </div>
            <div class="block__line">
              Nonce {{ block.nonce }} | Miner {{ block.miner }} | Diff {{ block.difficulty }} | Reward
              {{ block.reward }} MSH
            </div>
            <div class="block__tx" *ngFor="let tx of block.transactions; trackBy: trackTransaction">
              <div class="tx__line">
                <span class="mono">{{ tx.sender }}</span>
                <span class="arrow">-></span>
                <span class="mono">{{ tx.receiver }}</span>
                <span class="amount">{{ tx.amount | number : '1.0-2' }} MSH</span>
              </div>
              <div class="tx__line dim">
                {{ tx.timestamp | date : 'short' }}<span *ngIf="tx.note"> | "{{ tx.note }}"</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <ion-toast
    [isOpen]="!!toastMessage()"
    [message]="toastMessage() ?? ''"
    duration="2500"
    position="bottom"
    color="dark"
    (didDismiss)="toastMessage.set(null)">
  </ion-toast>
</ion-content>
